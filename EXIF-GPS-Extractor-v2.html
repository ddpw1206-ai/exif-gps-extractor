<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXIF GPS Extractor v2.0 - DB Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #dc2626;
            --danger-hover: #b91c1c;
            --success: #16a34a;
            --border: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-gray: #f9fafb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* í†µê³„ ëŒ€ì‹œë³´ë“œ */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-gray);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-card.new .stat-value {
            color: var(--success);
        }

        .loading {
            display: none;
            padding: 20px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 24px;
        }

        .loading.active {
            display: block;
        }

        .status-message {
            background: none;
            border: none;
            color: #166534;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 12px 0;
            text-align: center;
            font-size: 14px;
            line-height: 1.6;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-message.active {
            background: #f0fdf4;
            border: 1px solid #86efac;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 48px 24px;
            text-align: center;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -8px rgba(0, 0, 0, 0.1);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.08);
            transform: scale(1.01);
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            margin-bottom: 16px;
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .upload-area:hover .upload-icon {
            transform: scale(1.1);
        }

        .upload-text {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .upload-hint {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        /* í…Œì´ë¸” ì»¨íŠ¸ë¡¤ */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: var(--danger-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* í…Œì´ë¸” */
        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: var(--bg-gray);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            background: #e5e7eb;
        }

        th .sort-indicator {
            margin-left: 4px;
            font-size: 11px;
            opacity: 0.5;
        }

        th.sorted .sort-indicator {
            opacity: 1;
        }

        td {
            padding: 12px 16px;
            font-size: 13px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--bg-gray);
        }

        /* ì²´í¬ë°•ìŠ¤ */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        th.checkbox-col {
            width: 50px;
            text-align: center;
            cursor: pointer;
        }

        td.checkbox-col {
            text-align: center;
        }

        /* ì»¬ëŸ¼ ë„ˆë¹„ (1920px ê¸°ì¤€) */
        th:nth-child(1) {
            width: 50px;
        }

        th:nth-child(2) {
            width: 60px;
        }

        th:nth-child(3) {
            width: 280px;
        }

        th:nth-child(4) {
            width: 120px;
        }

        th:nth-child(5) {
            width: 120px;
        }

        th:nth-child(6) {
            width: 200px;
        }

        th:nth-child(7) {
            width: 120px;
        }

        th:nth-child(8) {
            width: 260px;
        }

        th:nth-child(9) {
            width: 260px;
        }

        th:nth-child(10) {
            width: 130px;
        }

        .map-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .map-link:hover {
            text-decoration: underline;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .loading.active {
            display: block;
        }

        /* Export ë²„íŠ¼ */
        .export-btn {
            background: var(--success);
            color: white;
        }

        .export-btn:hover {
            background: #15803d;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/exifreader@latest/dist/exif-reader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <div class="container">
        <div style="text-align: center; margin-bottom: 24px;">
            <h1
                style="color: var(--text-primary); font-size: 28px; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.025em;">
                ğŸ“¸ EXIF GPS Extractor v2.0</h1>
            <p class="subtitle" style="margin-bottom: 8px;">ì´ë¯¸ì§€ì˜ ë©”íƒ€ë°ì´í„°ì—ì„œ GPS ì¢Œí‘œë¥¼ ì¶”ì¶œí•˜ê³  ì§€ë²ˆ/ë„ë¡œëª… ì£¼ì†Œë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (IndexedDB ì˜êµ¬
                ì €ì¥)</p>
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">ğŸ“Œ GPS ì •ë³´ê°€ í¬í•¨ëœ ì‚¬ì§„ë§Œ ë³€í™˜ë©ë‹ˆë‹¤.</p>
            <div
                style="display: inline-block; text-align: left; background: var(--bg-gray); padding: 12px 20px; border-radius: 8px; font-size: 13px; color: var(--text-secondary); border: 1px solid var(--border);">
                <div style="margin-bottom: 6px;">ğŸ“± <strong>ì•„ì´í°</strong>: ì„¤ì • ì•± â†’ ê°œì¸ì •ë³´ ë³´í˜¸ ë° ë³´ì•ˆ â†’ ìœ„ì¹˜ ì„œë¹„ìŠ¤ ON</div>
                <div>ğŸ“· <strong>ê°¤ëŸ­ì‹œ</strong>: ì„¤ì • â†’ ìœ„ì¹˜ â†’ ON, ì¹´ë©”ë¼ ì•± â†’ "ìœ„ì¹˜ íƒœê·¸" ë˜ëŠ” "GPS íƒœê·¸" í™œì„±í™”</div>
            </div>
        </div>

        <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
        <div class="stats-dashboard">
            <div class="stat-card">
                <div class="stat-value" id="dbCount">0</div>
                <div class="stat-label">DB ëˆ„ì </div>
            </div>
            <div class="stat-card new">
                <div class="stat-value" id="sessionCount">0</div>
                <div class="stat-label">ì´ë²ˆ ì¶”ì¶œ</div>
            </div>
        </div>

        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept="image/*" multiple>
            <div class="upload-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="rgba(245, 158, 11, 0.15)" stroke="#f59e0b"
                    stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z">
                    </path>
                    <path d="M12 11v6M9 14h6"></path>
                </svg>
            </div>
            <div class="upload-text">ì´ë¯¸ì§€ íŒŒì¼ì„ ì´ê³³ìœ¼ë¡œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•˜ì„¸ìš”</div>
            <div class="upload-hint">ë˜ëŠ” ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</div>
            <button type="button" class="btn-primary" style="margin-top: 8px; pointer-events: none;">íŒŒì¼ ì°¾ì•„ë³´ê¸°</button>
        </div>

        <div class="loading" id="loading">ì²˜ë¦¬ ì¤‘...</div>
        <div class="status-message" id="statusMessage">-</div>

        <div class="table-controls">
            <div class="table-title">ì¶”ì¶œ ê²°ê³¼</div>
            <div class="button-group">
                <button class="btn-danger" id="deleteSelectedBtn" disabled>ì„ íƒ ì‚­ì œ</button>
                <button class="btn-danger" id="deleteAllBtn" disabled>ì „ì²´ ì‚­ì œ</button>
                <button class="export-btn" id="exportCsvBtn" disabled>CSV ë‚´ë³´ë‚´ê¸°</button>
                <button class="export-btn" id="exportExcelBtn" disabled>Excel ë‚´ë³´ë‚´ê¸°</button>
            </div>
        </div>

        <!-- ê²°ê³¼ í…Œì´ë¸” -->
        <div class="table-wrapper">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th class="checkbox-col" id="selectAll">
                            <input type="checkbox" id="selectAllCheckbox">
                        </th>
                        <th class="sortable" data-column="id">No <span class="sort-indicator">â–¼</span></th>
                        <th class="sortable" data-column="filename">íŒŒì¼ëª… <span class="sort-indicator">â–¼</span></th>
                        <th class="sortable" data-column="latitude">ìœ„ë„ <span class="sort-indicator">â–¼</span></th>
                        <th class="sortable" data-column="longitude">ê²½ë„ <span class="sort-indicator">â–¼</span></th>
                        <th>ì¢Œí‘œ (Y, X)</th>
                        <th>ì§€ë„ ë§í¬</th>
                        <th class="sortable" data-column="parcelAddress">ì§€ë²ˆì£¼ì†Œ <span class="sort-indicator">â–¼</span></th>
                        <th class="sortable" data-column="roadAddress">ë„ë¡œëª…ì£¼ì†Œ (ì¶”ì •) <span class="sort-indicator">â–¼</span>
                        </th>
                        <th class="sortable" data-column="timestamp">ë“±ë¡ì¼ <span class="sort-indicator">â–¼</span></th>
                    </tr>
                </thead>
                <tbody id="resultBody">
                    <tr>
                        <td colspan="10" class="no-data">ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // IndexedDB ì´ˆê¸°í™”
        let db;
        const DB_NAME = 'ExifGpsDB';
        const STORE_NAME = 'gpsData';
        const DB_VERSION = 1;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('filename', 'filename', { unique: false });
                        objectStore.createIndex('coordinates', ['latitude', 'longitude'], { unique: false });
                        objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        };

        const saveData = (data) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.add(data);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        const getAllData = () => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        const deleteData = (id) => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        };

        const deleteAllData = () => {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.clear();

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        };

        // ì¤‘ë³µ ì²´í¬ (íŒŒì¼ëª… + ì¢Œí‘œ ë³µí•©)
        const isDuplicate = async (filename, latitude, longitude) => {
            const _allData = await getAllData();
            return _allData.some(item =>
                item.filename === filename &&
                Math.abs(item.latitude - latitude) < 0.000001 &&
                Math.abs(item.longitude - longitude) < 0.000001
            );
        };

        // ì „ì—­ ìƒíƒœ
        let allData = [];
        let sortColumn = 'id';
        let sortDirection = 'desc';
        let newDataCount = 0;

        // DOM ìš”ì†Œ
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const resultBody = document.getElementById('resultBody');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const statusMessage = document.getElementById('statusMessage');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const deleteAllBtn = document.getElementById('deleteAllBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');

        (async () => {
            await initDB();
            await loadData();
        })();

        async function loadData() {
            allData = await getAllData();
            updateStats();
            renderTable();
        }

        function updateStats() {
            document.getElementById('dbCount').textContent = allData.length;
            document.getElementById('sessionCount').textContent = newDataCount;
        }

        // -----------------------------
        // EXIF / GPS / Vworld ë¡œì§ (index.html ê¸°ë°˜)
        // -----------------------------

        function convertDMSToDecimal(dmsArray, ref) {
            try {
                if (!dmsArray) return null;

                let deg, min, sec;
                const getValue = (val) => {
                    if (Array.isArray(val)) return val[0] / val[1];
                    if (typeof val === 'number') return val;
                    if (val && typeof val.numerator !== 'undefined') return val.numerator / val.denominator;
                    return 0;
                };

                if (Array.isArray(dmsArray) && dmsArray.length >= 3) {
                    deg = getValue(dmsArray[0]);
                    min = getValue(dmsArray[1]);
                    sec = getValue(dmsArray[2]);
                } else {
                    return null;
                }

                let decimal = deg + (min / 60) + (sec / 3600);
                if (ref === 'S' || ref === 'W') decimal = decimal * -1;

                return decimal.toFixed(6);
            } catch (error) {
                return null;
            }
        }

        function getRef(tag, defaultRef) {
            if (!tag) return defaultRef;
            if (Array.isArray(tag.value) && typeof tag.value[0] === 'string') return tag.value[0].charAt(0).toUpperCase();
            if (typeof tag.value === 'string') return tag.value.charAt(0).toUpperCase();
            if (typeof tag.description === 'string') return tag.description.charAt(0).toUpperCase();
            return defaultRef;
        }

        function getVworldAddress(lat, lng) {
            return new Promise((resolve) => {
                const cbName = 'cb_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                const script = document.createElement('script');

                script.src = `https://api.vworld.kr/req/address?service=address&request=getAddress&version=2.0&crs=epsg:4326&point=${lng},${lat}&format=json&type=both&zipcode=true&simple=false&key=1093C6FE-9827-3C31-ADD5-20298B8AD1A1&callback=${cbName}`;

                const timer = setTimeout(() => {
                    cleanup();
                    resolve({ road: '-', parcel: '-' });
                }, 5000);

                window[cbName] = function (data) {
                    clearTimeout(timer);
                    cleanup();

                    console.log('Vworld ì‘ë‹µ:', JSON.stringify(data));

                    const result = data?.response?.result;
                    const road = result?.find(r => r.type?.toUpperCase() === 'ROAD')?.text || '-';
                    const parcel = result?.find(r => r.type?.toUpperCase() === 'PARCEL')?.text || '-';

                    console.log('ë„ë¡œëª…:', road, '/ ì§€ë²ˆ:', parcel);
                    resolve({ road, parcel });
                };

                script.onerror = function () {
                    clearTimeout(timer);
                    cleanup();
                    resolve({ road: '-', parcel: '-' });
                };

                function cleanup() {
                    delete window[cbName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                }

                document.head.appendChild(script);
            });
        }

        // íŒŒì¼ ì—…ë¡œë“œ / ì²˜ë¦¬
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            await processFiles(Array.from(e.dataTransfer.files));
        });

        fileInput.addEventListener('change', async (e) => {
            await processFiles(Array.from(e.target.files));
            fileInput.value = '';
        });

        let sessionErrors = [];

        async function processFiles(files) {
            loading.classList.add('active');

            // ì´ˆê¸°í™”: ë©”ì‹œì§€ëŠ” ìœ ì§€í•˜ë˜ ìŠ¤íƒ€ì¼ë§Œ ì œê±°í•˜ê±°ë‚˜ '-' í‘œì‹œ
            statusMessage.classList.remove('active');
            statusMessage.innerHTML = '-';

            newDataCount = 0;
            sessionErrors = [];
            let totalFiles = files.length;
            let duplicatesCount = 0;

            for (const file of files) {
                try {
                    const result = await processFile(file);
                    if (!result.success) {
                        if (result.reason === "ì´ë¯¸ ë“±ë¡ëœ ì¤‘ë³µ íŒŒì¼ì…ë‹ˆë‹¤.") {
                            duplicatesCount++;
                        } else {
                            sessionErrors.push({ filename: file.name, message: result.reason });
                        }
                    }
                } catch (error) {
                    console.error(error);
                    sessionErrors.push({ filename: file.name, message: "íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
                }
            }

            await loadData(); // renderTable í˜¸ì¶œ
            loading.classList.remove('active');

            // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
            statusMessage.classList.add('active');
            let msg = `âœ… ì¶”ì¶œ ì™„ë£Œ â€” ì´ ${totalFiles}ê°œ íŒŒì¼ ì¤‘ ${newDataCount}ê°œ ì‹ ê·œ ì¶”ì¶œ`;
            if (duplicatesCount > 0) {
                msg += ` (${duplicatesCount}ê°œ ì¤‘ë³µ ì œì™¸)`;
            }
            statusMessage.innerHTML = msg;
        }

        async function processFile(file) {
            try {
                const tags = await ExifReader.load(file);

                let latitude = null;
                let longitude = null;

                if (tags['GPSLatitude'] && tags['GPSLongitude']) {
                    const latDMS = tags['GPSLatitude'].value;
                    const lonDMS = tags['GPSLongitude'].value;
                    const latRef = getRef(tags['GPSLatitudeRef'], 'N');
                    const lonRef = getRef(tags['GPSLongitudeRef'], 'E');

                    latitude = convertDMSToDecimal(latDMS, latRef);
                    longitude = convertDMSToDecimal(lonDMS, lonRef);

                    if (latitude === null || isNaN(latitude)) {
                        latitude = typeof tags['GPSLatitude'].description === 'number' ? tags['GPSLatitude'].description.toFixed(6) : tags['GPSLatitude'].description;
                    }
                    if (longitude === null || isNaN(longitude)) {
                        longitude = typeof tags['GPSLongitude'].description === 'number' ? tags['GPSLongitude'].description.toFixed(6) : tags['GPSLongitude'].description;
                    }
                }

                if (latitude && longitude) {
                    const latNum = parseFloat(latitude);
                    const lonNum = parseFloat(longitude);

                    // ì¤‘ë³µ ì²´í¬ (IndexedDB ìš©)
                    const duplicate = await isDuplicate(file.name, latNum, lonNum);
                    if (duplicate) {
                        return { success: false, reason: "ì´ë¯¸ ë“±ë¡ëœ ì¤‘ë³µ íŒŒì¼ì…ë‹ˆë‹¤." };
                    }

                    // Vworld ì£¼ì†Œ API: ë¦¬ë²„ìŠ¤ ì§€ì˜¤ì½”ë”© (ì¢Œí‘œ -> ì£¼ì†Œ) (JSONP ë°©ì‹)
                    const addrInfo = await getVworldAddress(latitude, longitude);
                    let roadAddress = addrInfo.road;
                    let lotAddress = addrInfo.parcel;

                    if (roadAddress === '-') {
                        const lat5 = parseFloat(latitude).toFixed(5);
                        const lng5 = parseFloat(longitude).toFixed(5);
                        const addrInfo5 = await getVworldAddress(lat5, lng5);
                        if (addrInfo5.road !== '-') {
                            roadAddress = addrInfo5.road;
                        }
                    }

                    // ë°ì´í„° ì €ì¥ (IndexedDB)
                    const data = {
                        filename: file.name,
                        latitude: latNum,
                        longitude: lonNum,
                        parcelAddress: lotAddress,
                        roadAddress: roadAddress,
                        timestamp: Date.now()
                    };

                    await saveData(data);
                    newDataCount++;
                    return { success: true };
                } else {
                    return { success: false, reason: "GPS ë©”íƒ€ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." };
                }
            } catch (err) {
                console.error(err);
                return { success: false, reason: "íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };
            }
        }

        // -----------------------------
        // í…Œì´ë¸” ë Œë”ë§ / ì‚­ì œ / ì •ë ¬ / ë²„íŠ¼ ì•¡ì…˜
        // -----------------------------

        function renderTable() {
            let html = '';

            if (allData.length === 0 && (!sessionErrors || sessionErrors.length === 0)) {
                resultBody.innerHTML = '<tr><td colspan="10" class="no-data">ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                deleteAllBtn.disabled = true;
                exportCsvBtn.disabled = true;
                exportExcelBtn.disabled = true;
                return;
            }

            const sortedData = [...allData].sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];

                if (sortColumn === 'timestamp') {
                    return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                }

                if (typeof aVal === 'string') {
                    return sortDirection === 'asc'
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                }

                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });

            if (sortedData.length > 0) {
                html += sortedData.map((item, index) => {
                    const date = new Date(item.timestamp);
                    const formattedDate =
                        `${String(date.getFullYear()).slice(2)}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ` +
                        `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                    const latFixed = item.latitude.toFixed(6);
                    const lngFixed = item.longitude.toFixed(6);
                    const coordText = `${latFixed}&nbsp;&nbsp;&nbsp;&nbsp;${lngFixed}`;

                    const googleLink = `https://www.google.com/maps?q=${item.latitude},${item.longitude}&ll=${item.latitude},${item.longitude}&z=17`;
                    const naverLink = `https://map.naver.com/p/search/${item.latitude}%2C${item.longitude}`;

                    return `
                    <tr>
                        <td class="checkbox-col">
                            <input type="checkbox" class="row-checkbox" data-id="${item.id}">
                        </td>
                        <td>${index + 1}</td>
                        <td>${item.filename}</td>
                        <td>${latFixed}</td>
                        <td>${lngFixed}</td>
                        <td class="col-xy">${coordText}</td>
                        <td>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <a href="${googleLink}" target="_blank" class="map-link" title="êµ¬ê¸€ì§€ë„">
                                    <img src="https://www.google.com/favicon.ico" alt="G" width="20" height="20" style="border-radius: 50%;">
                                </a>
                                <a href="${naverLink}" target="_blank" class="map-link" title="ë„¤ì´ë²„ì§€ë„" style="text-decoration: none;">
                                    <div style="width: 20px; height: 20px; background-color: #03c75a; color: white; display: flex; justify-content: center; align-items: center; font-weight: 800; font-size: 14px; border-radius: 4px; font-family: Arial, sans-serif;">N</div>
                                </a>
                            </div>
                        </td>
                        <td>${item.parcelAddress}</td>
                        <td>${item.roadAddress}</td>
                        <td>${formattedDate}</td>
                    </tr>
                    `;
                }).join('');
            }

            if (sessionErrors && sessionErrors.length > 0) {
                html += sessionErrors.map(err => `
                    <tr style="background-color: #fef2f2;">
                        <td></td>
                        <td>-</td>
                        <td style="color: var(--danger); font-weight: 500;">âŒ ${err.filename}</td>
                        <td colspan="7" style="color: var(--danger); text-align: left;">${err.message}</td>
                    </tr>
                `).join('');
            }

            resultBody.innerHTML = html;

            deleteAllBtn.disabled = sortedData.length === 0;
            exportCsvBtn.disabled = sortedData.length === 0;
            exportExcelBtn.disabled = sortedData.length === 0;
            updateDeleteButtonState();
        }

        selectAllCheckbox.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            updateDeleteButtonState();
        });

        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('row-checkbox')) {
                updateDeleteButtonState();
            }
        });

        function updateDeleteButtonState() {
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            deleteSelectedBtn.disabled = checkedCount === 0;
        }

        deleteSelectedBtn.addEventListener('click', async () => {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const ids = Array.from(checkedBoxes).map(cb => Number(cb.dataset.id));

            if (confirm(`ì„ íƒí•œ ${ids.length}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                loading.classList.add('active');
                for (const id of ids) {
                    await deleteData(id);
                }
                newDataCount = 0;
                await loadData();
                selectAllCheckbox.checked = false;
                loading.classList.remove('active');
            }
        });

        deleteAllBtn.addEventListener('click', async () => {
            if (confirm(`ì „ì²´ ${allData.length}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                loading.classList.add('active');
                await deleteAllData();
                newDataCount = 0;
                await loadData();
                selectAllCheckbox.checked = false;
                loading.classList.remove('active');
            }
        });

        function getExportData() {
            return allData.map((item, index) => {
                const date = new Date(item.timestamp);
                const formattedDate =
                    `${String(date.getFullYear()).slice(2)}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ` +
                    `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                const latFixed = item.latitude.toFixed(6);
                const lngFixed = item.longitude.toFixed(6);

                const googleLink = `https://www.google.com/maps?q=${item.latitude},${item.longitude}&ll=${item.latitude},${item.longitude}&z=17`;
                const naverLink = `https://map.naver.com/p/search/${item.latitude}%2C${item.longitude}`;

                return {
                    "No": index + 1,
                    "íŒŒì¼ëª…": item.filename,
                    "ìœ„ë„(Latitude, y)": latFixed,
                    "ê²½ë„(Longitude, x)": lngFixed,
                    "ì¢Œí‘œ (Y, X)": `${latFixed}    ${lngFixed}`,
                    "êµ¬ê¸€ì§€ë„": googleLink,
                    "ë„¤ì´ë²„ì§€ë„": naverLink,
                    "ì§€ë²ˆì£¼ì†Œ": item.parcelAddress,
                    "ë„ë¡œëª…ì£¼ì†Œ (ì¶”ì •)": item.roadAddress,
                    "ë“±ë¡ì¼": formattedDate
                };
            });
        }

        exportExcelBtn.addEventListener('click', () => {
            if (allData.length === 0) return alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            const ws = XLSX.utils.json_to_sheet(getExportData());
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "GPS_Data");
            XLSX.writeFile(wb, "gps_extractor_results.xlsx");
        });

        exportCsvBtn.addEventListener('click', () => {
            if (allData.length === 0) return alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            const ws = XLSX.utils.json_to_sheet(getExportData());
            const csv = XLSX.utils.sheet_to_csv(ws, { FS: "," });

            const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `exif-gps-data-${new Date().getTime()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.column;

                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }

                document.querySelectorAll('.sortable').forEach(header => {
                    header.classList.remove('sorted');
                    const indicator = header.querySelector('.sort-indicator');
                    indicator.textContent = 'â–¼';
                });

                th.classList.add('sorted');
                const indicator = th.querySelector('.sort-indicator');
                indicator.textContent = sortDirection === 'asc' ? 'â–²' : 'â–¼';

                renderTable();
            });
        });
    </script>

</body>

</html>